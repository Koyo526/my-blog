# トップページ 掲示板機能 実装計画

## 概要
トップページに掲示板を追加し、訪問者が名前（省略可能）とコメントを投稿できるようにする

## 基本要件
- 名前フィールド（省略時は「名無しさん」）
- コメントフィールド
- スクロール表示

---

## 要件確認（質問事項）

### Q1: データ保存先
[Question] コメントデータの保存先はどれを使用しますか？

- A) Vercel KV（Redis）- 訪問者カウントと同じ、シンプル
- B) Vercel Postgres - リレーショナルDB、将来の拡張性あり
- C) 外部サービス（Firebase, Supabase等）

[Answer]
- B) Vercel Postgres - リレーショナルDB、将来の拡張性あり
ただし無料枠で行いたいです。
---

### Q2: 表示位置
[Question] 掲示板をトップページのどこに配置しますか？

- A) 訪問者カウントの下
- B) Featured Projectsの下（ページ下部）
- C) その他（具体的に指定）

[Answer]
- B) Featured Projectsの下（ページ下部）
---


### Q3: 表示件数
[Question] スクロールエリアに表示するコメントの最大件数は？

- A) 10件
- B) 20件
- C) 50件
- D) その他（具体的に指定）

[Answer]
- A) 10件
---

### Q4: スクロールエリアの高さ
[Question] 掲示板のスクロールエリアの高さはどれくらいが良いですか？

- A) 小さめ（200px程度）
- B) 中くらい（300px程度）
- C) 大きめ（400px程度）

[Answer]
- B) 中くらい（300px程度）
---

### Q5: 文字数制限
[Question] 名前とコメントに文字数制限を設けますか？

- A) 名前: 20文字、コメント: 200文字
- B) 名前: 30文字、コメント: 500文字
- C) 制限なし
- D) その他（具体的に指定）

[Answer]
- A) 名前: 20文字、コメント: 200文字
---

### Q6: タイムスタンプ表示
[Question] コメントの投稿日時を表示しますか？

- A) はい（相対時間：「5分前」「1時間前」など）
- B) はい（絶対時間：「2026/01/02 12:34」）
- C) いいえ（表示しない）

[Answer]
- A) はい（相対時間：「5分前」「1時間前」など）
---

### Q7: 表示順序
[Question] コメントの表示順序はどうしますか？

- A) 新しい順（上が最新）
- B) 古い順（上が最古）

[Answer]
- A) 新しい順（上が最新）
---

### Q8: 削除機能
[Question] コメントの削除機能は必要ですか？

- A) 不要（投稿されたら削除不可）
- B) 管理者のみ削除可能（別途管理画面が必要）
- C) 投稿者が削除可能（パスワード等の仕組みが必要）

[Answer]
- B) 管理者のみ削除可能（別途管理画面が必要）
---

### Q9: 多言語対応
[Question] 掲示板のUI（ラベル、ボタン等）は多言語対応しますか？

- A) はい（日本語/英語）
- B) いいえ（日本語のみ）

[Answer]
- A) はい（日本語/英語）
---

### Q10: デザインスタイル
[Question] 掲示板のデザインスタイルはどうしますか？

- A) 訪問者カウントと同じグラスモーフィズム
- B) シンプルなカード（既存のプロジェクトカードと同様）
- C) その他（具体的に指定）

[Answer]
- A) 訪問者カウントと同じグラスモーフィズム
---

## 要件サマリー

| 項目 | 決定内容 |
|------|----------|
| データ保存先 | Vercel Postgres（無料枠） |
| 表示位置 | Featured Projectsの下 |
| 表示件数 | 10件 |
| スクロール高さ | 300px |
| 文字数制限 | 名前: 20文字、コメント: 200文字 |
| タイムスタンプ | 相対時間（「5分前」など） |
| 表示順序 | 新しい順 |
| 削除機能 | 管理者のみ |
| 多言語対応 | 日本語/英語 |
| デザイン | グラスモーフィズム |

---

## セキュリティ・スパム対策

### 1. レート制限（Vercel KV 使用）
- IPごとに30秒に1回の投稿制限
- 既存の Vercel KV を活用

### 2. 入力フィルタリング
- `http` を含む投稿をブロック（URL スパム対策）
- `name.trim()` / `content.trim()` で空白のみ投稿を防止

### 3. Honeypot フィールド
- 非表示の入力フィールドを設置
- ボットが入力した場合は投稿を拒否

### 4. API セキュリティ
- `Cache-Control: no-store` でキャッシュ無効化
- `created_at` は DB 側で設定（クライアント時刻は信用しない）
- 削除 API は `timingSafeEqual` で認証
- Origin チェック（自サイトからの呼び出しのみ許可）

### 5. DB 初期化 API の保護
- `ADMIN_SECRET` 必須
- 本番環境では無効化（`process.env.NODE_ENV === 'production'` で 404）

---

## 実装ステップ

### Step 1: Vercel Postgres のセットアップ
- [x] 1.1 Vercel ダッシュボードで Postgres データベースを作成（無料枠: Hobby）
- [x] 1.2 プロジェクトにデータベースを接続
- [x] 1.3 環境変数を `.env.local` に追加
- [x] 1.4 `@vercel/postgres` パッケージをインストール

[Question] Vercel Postgres の作成はダッシュボードで行う必要があります。作成後、環境変数を `.env.local` に追加してください。準備ができたら教えてください。

[Answer] 完了。Neon Postgres を作成し、環境変数を設定済み。

---

### Step 2: データベーススキーマの作成
- [x] 2.1 `lib/db/schema.ts` を作成（テーブル定義）
- [x] 2.2 `lib/db/init.ts` を作成（テーブル初期化スクリプト）
- [x] 2.3 初期化APIエンドポイント `/api/db/init` を作成（ADMIN_SECRET 必須、本番無効化）

**テーブル構造（改善版）:**
```sql
CREATE TABLE comments (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(20) NOT NULL DEFAULT '名無しさん',
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX comments_created_at_idx ON comments (created_at DESC);
```

**改善ポイント:**
- `BIGSERIAL`: 将来の拡張性
- `TEXT`: 長さ制限はアプリ側バリデーションで担保
- `TIMESTAMPTZ`: タイムゾーン対応（Vercel/Neon系で安全）
- インデックス: 新しい順ソートの高速化

---

### Step 3: API エンドポイントの作成
- [x] 3.1 `app/api/comments/route.ts` を作成
  - GET: コメント一覧取得（最新10件）
    - `Cache-Control: no-store` ヘッダー設定
  - POST: 新規コメント投稿
    - `name.trim()` / `content.trim()` で正規化
    - `http` を含む投稿をブロック
    - Honeypot チェック
    - レート制限（Vercel KV で IP ごと30秒に1回）
- [x] 3.2 `app/api/comments/[id]/route.ts` を作成
  - DELETE: 管理者によるコメント削除
    - `x-admin-secret` ヘッダーで認証
    - `timingSafeEqual` で比較（タイミング攻撃対策）
    - Origin チェック
- [x] 3.3 バリデーション実装（文字数制限: 名前20、コメント200）

---

### Step 4: ユーティリティ関数の作成
- [x] 4.1 `lib/utils/relative-time.ts` を作成（相対時間表示用）
  - `Intl.RelativeTimeFormat` を使用（多言語対応）
  - 言語引数（`lang: 'ja' | 'en'`）を受け取る設計

---

### Step 5: 掲示板コンポーネントの作成
- [x] 5.1 `types/board.ts` を作成（型定義）
- [x] 5.2 `components/home/board/comment-form.tsx` を作成（投稿フォーム）
  - グラスモーフィズムカード背景
  - 入力は通常の border スタイル（読みやすさ重視）
  - Honeypot 隠しフィールド
- [x] 5.3 `components/home/board/comment-list.tsx` を作成（コメント一覧）
  - `overflow-y-auto` で 300px スクロール
  - `divide-y divide-border/40` で境界線表示（掲示板らしいデザイン）
- [x] 5.4 `components/home/board/comment-item.tsx` を作成（個別コメント）
- [x] 5.5 `components/home/board/board.tsx` を作成（メインコンポーネント）
- [x] 5.6 `components/home/board/index.ts` を作成（エクスポート）

---

### Step 6: トップページへの統合
- [x] 6.1 `components/home/index.ts` にエクスポート追加
- [x] 6.2 `app/[lang]/page.tsx` に Board コンポーネントを追加

---

### Step 7: 翻訳ファイルの更新
- [x] 7.1 `locales/ja.json` に掲示板用翻訳キーを追加
- [x] 7.2 `locales/en.json` に掲示板用翻訳キーを追加

---

### Step 8: 管理者削除機能
- [x] 8.1 環境変数 `ADMIN_SECRET` を設定（.env.local + Vercel）
- [x] 8.2 削除 API の認証処理を実装
  - `crypto.timingSafeEqual` でタイミング攻撃対策
  - Origin ヘッダーチェック

---

### Step 9: テストとデプロイ
- [ ] 9.1 ローカルでの動作確認
- [x] 9.2 ビルド確認
- [ ] 9.3 コミット & プッシュ
- [ ] 9.4 Vercel でのデプロイ確認

---

## 作成/変更ファイル一覧

| ファイル | 操作 | 内容 |
|----------|------|------|
| `package.json` | 更新 | `@vercel/postgres` 追加 |
| `types/board.ts` | 新規 | Comment 型定義 |
| `lib/db/schema.ts` | 新規 | テーブル定義 |
| `lib/db/init.ts` | 新規 | 初期化処理 |
| `lib/utils/relative-time.ts` | 新規 | 相対時間ユーティリティ（Intl.RelativeTimeFormat） |
| `lib/utils/rate-limit.ts` | 新規 | レート制限ユーティリティ（Vercel KV 使用） |
| `app/api/db/init/route.ts` | 新規 | DB初期化エンドポイント（保護付き） |
| `app/api/comments/route.ts` | 新規 | コメント GET/POST API |
| `app/api/comments/[id]/route.ts` | 新規 | コメント削除 API（管理者のみ） |
| `components/home/board/*.tsx` | 新規 | 掲示板コンポーネント群（5ファイル） |
| `components/home/index.ts` | 更新 | エクスポート追加 |
| `app/[lang]/page.tsx` | 更新 | Board 統合 |
| `locales/ja.json` | 更新 | 翻訳追加 |
| `locales/en.json` | 更新 | 翻訳追加 |

---

## UIデザイン案

### レイアウト
```
┌─────────────────────────────────────────────────────────┐
│  📝 掲示板 / Message Board                               │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐    │
│  │ 名前（省略可）: [________________]               │    │
│  │ コメント:       [________________________________│    │
│  │                 [________________________________│    │
│  │                 [________________] [投稿ボタン]   │    │
│  └─────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐    │
│  │ ▼ コメント一覧（スクロール: 300px）              │    │
│  │ ┌─────────────────────────────────────────────┐ │    │
│  │ │ 名無しさん              5分前               │ │    │
│  │ │ こんにちは！素敵なサイトですね。           │ │    │
│  │ └─────────────────────────────────────────────┘ │    │
│  │ ┌─────────────────────────────────────────────┐ │    │
│  │ │ Koyo                    1時間前             │ │    │
│  │ │ ありがとうございます！                     │ │    │
│  │ └─────────────────────────────────────────────┘ │    │
│  │ ...                                            │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

---

## ステータス
- [x] 要件確認完了
- [x] 計画承認
- [x] 実装完了（ビルド確認済み、ローカルテスト・デプロイ待ち）
